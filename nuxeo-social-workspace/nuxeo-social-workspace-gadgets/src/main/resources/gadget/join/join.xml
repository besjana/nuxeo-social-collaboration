<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Join"
    description="Join to Social Workspace gadget"
    author="ei" author_email="ei@nuxeo.com"
    height="420">
    <Require feature="setprefs"/>
    <#include "dynamic-translations.ftl"/>
    <Require feature="dynamic-height" />
    <#include "default-oauth-prefs.ftl"/>
  </ModulePrefs>
  <#include "context-prefs.ftl"/>
  <Content type="html">

<![CDATA[
<html>
  <head>

  <link rel="stylesheet" type="text/css" href="/nuxeo/site/skin/gadgets/css/gadget-common.css"/>

  <!-- insert JS Context -->
  ${jsContext}

  <script src="${specDirectoryUrl}default-automation-request.js"></script>
  <script src="${specDirectoryUrl}context-management.js"></script>

  <script>
   var prefs = new _IG_Prefs(__MODULE_ID__);

   var socialWorkspacePath = getTargetContextPath();
   var getSocialWorkspaceQuery = 'select * from SocialWorkspace where ecm:path = \'' + socialWorkspacePath + '\'';

   //var NXRequestParams={ operationId : 'Document.Query',            // id of operation or chain to execute
   //  operationParams : { query : getSocialWorkspaceQuery},    	    // parameters for the chain or operation
   //  operationContext : {},                                         // context
   //  operationDocumentProperties : "common,dublincore",
   //  entityType : 'documents',
   //  displayMethod : displaySocialWorkspaceDescription
   //};

   var NXRequestParams = {
   		operationId : 'SocialWorkspace.Statute',
   		operationParams : {
   		 socialWorkspacePath : socialWorkspacePath
   		},
   		entityType : 'blob',
   		operationContext : {},
   		operationCallback : displayStatut
   }



	function disableButton() {
		_gel("statusMessage").innerHTML = "__MSG_label.request.registered__";
	    _gel("joinButton").style.display = 'none';
	}

   function displaySocialWorkspaceDescription(entries) {
   		msg = ""
   		if ( entries.length > 0 ) {
   			msg = entries[0].properties["dc:description"];
   		}
   		_gel("socialWorkspaceDescription").innerHTML = msg;
   		gadgets.window.adjustHeight();
   }

   function displayStatut(response, nxParams) {
   		statute = response.data["statute"];
   		_gel("socialWorkspaceDescription").innerHTML = response.data["description"];
		if ( "REQUEST_PENDING" == statute ) {
			_gel("statusMessage").innerHTML = "__MSG_label.request.alreadyRegistered__";
			_gel("joinButton").style.display = 'none';
		}
		if ( "MEMBER" == statute ) {
			_gel("statusMessage").innerHTML = "__MSG_label.request.alreadyMember__";
			_gel("joinButton").style.display = 'none';
		}
		gadgets.window.adjustHeight();
   }

   // execute automation request onload
   gadgets.util.registerOnLoadHandler(function() {
     doAutomationRequest(NXRequestParams);
     gadgets.window.adjustHeight();
   } );

   var NXJoinRequestParams = {
   		operationId : 'Social.Join',
   		operationParams : {
   		 socialWorkspacePath : socialWorkspacePath
   		},
   		operationContext : {},
   		operationCallback : disableButton
   }

   function joinSocialWorkspace() {
   	    doAutomationRequest(NXJoinRequestParams);
   };

  </script>
  </head>
    <body>

      <div class="content">
        <#include "default-request-controls.ftl"/>
        <p id="socialWorkspaceDescription">
        </p>
        <p id="statusMessage">__MSG_label.gadget.joinDescription__</p>
        <button onClick="joinSocialWorkspace()" id="joinButton">__MSG_label.gadget.joinButton__</button>
      </div>
    </body>
</html>
]]>
  </Content>
</Module>
