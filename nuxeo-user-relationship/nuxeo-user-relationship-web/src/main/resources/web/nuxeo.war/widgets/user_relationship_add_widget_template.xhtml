<f:subview xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:a4j="http://richfaces.org/a4j"
  id="#{widget.id}" rendered="#{widget.mode == 'view' }">

  <c:set var="andLabel" value=" #{messages['label.and']} " scope="page" />
  <c:set var="displayedName" value="#{nxu:test(empty userManagementActions.selectedUser.user.firstName, userManagementActions.selectedUser.id, userManagementActions.selectedUser.user.firstName)}" scope="page" />
  <a4j:outputPanel id="userRelationPanel" >

    <a4j:outputPanel rendered="#{!userRelationshipActions.currentUser}" id="user_relationship_#{widget.id}">

      <a4j:outputPanel styleClass="action_bar" id="add_relationship_#{widget.id}_btn">
        <a4j:outputPanel styleClass="relationship_label" rendered="#{not userRelationshipActions.alreadyConnected}">
          <h:outputFormat value="#{messages['action.social.user.relationship.not.in.relation']}">
            <f:param value="#{displayedName}" />
          </h:outputFormat>
        </a4j:outputPanel>

        <a4j:outputPanel styleClass="relationship_label" rendered="#{userRelationshipActions.alreadyConnected}">
          <h:outputFormat value="#{messages['action.social.user.relationship.in.relation']} ">
            <f:param value="#{displayedName}" />
          </h:outputFormat>

          <c:forEach var="relation" items="#{userRelationshipActions.relationshipsWithSelectedUser}" varStatus="status">
            <c:if test="#{!status.first}">#{status.last ? andLabel : ', '}</c:if>
            <h:outputText value="#{relation.name}" />
          </c:forEach>
        </a4j:outputPanel>

        <a4j:outputPanel rendered="#{not userRelationshipActions.alreadyConnected}">
          <a class="button relationship_#{widget.id}_button">
            <h:outputText value="#{messages['action.social.user.relationship.addNew']}" />
          </a>
        </a4j:outputPanel>
        <a4j:outputPanel rendered="#{userRelationshipActions.alreadyConnected}">
          <a class="button relationship_#{widget.id}_button">
            <h:outputText value="#{messages['action.social.user.relationship.join']}" />
          </a>
        </a4j:outputPanel>
        <script type="text/javascript">
          var btn = jQuery(".relationship_#{widget.id}_button");
          btn.click(function() {
            return false;
          });
          btn.mouseenter(function() {
             jQuery("#add_relationship_#{widget.id}").fadeIn(500);
          });
        </script>
      </a4j:outputPanel>
      <div class="relationPopUpContainer">
        <div id="add_relationship_#{widget.id}" class="relationPopUp">
          <a4j:status>
            <f:facet name="start">
              <h:graphicImage value="/img/standart_waiter.gif" />
            </f:facet>
          </a4j:status>
          <a4j:outputPanel id="add_relationship_#{widget.id}">
            <nxu:dataTable id="#{widget.id}_add_relationship"
              value="#{userRelationshipActions.kinds}" var="kind"
              rendered="#{!(userRelationshipActions.currentUser)}">

              <nxu:column>
                <h:selectBooleanCheckbox valueChangeListener="#{userRelationshipActions.relationshipCheckboxChanged}"
                  value="#{userRelationshipActions.allRelationshipsState[kind]}">
                  <a4j:support event="onchange"
                    reRender="add_relationship_#{widget.id}_btn,facesStatusMessagePanel">
                    <f:param name="selectedKind" value="#{kind.toString()}" />
                  </a4j:support>
                  <span><h:outputText value="#{kind.name}" /></span>
                </h:selectBooleanCheckbox>
              </nxu:column>
            </nxu:dataTable>
            <script type="text/javascript">
              var div = jQuery("#add_relationship_#{widget.id}");
              div.mouseleave(function() {
                jQuery("#add_relationship_#{widget.id}").fadeOut(500);
              });
            </script>
          </a4j:outputPanel>
        </div>
      </div>
    </a4j:outputPanel>

  </a4j:outputPanel>
</f:subview>
