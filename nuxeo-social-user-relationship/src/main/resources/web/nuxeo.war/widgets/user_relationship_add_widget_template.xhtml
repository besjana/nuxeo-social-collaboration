<f:subview xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:c="http://java.sun.com/jstl/core"
  xmlns:nxu="http://nuxeo.org/nxweb/util"
  xmlns:a4j="http://richfaces.org/a4j"
  id="#{widget.id}" rendered="#{widget.mode == 'view' }">

  <style type="text/css">
    div#add_relationship_#{widget.id} {
      position: absolute;
      border: 1px solid #333;
      width: 100px;
      background-color: white;
      z-index:1000;
    }

    #add_relationship_#{widget.id} table {
      width: 100%;
    }

    #add_relationship_#{widget.id} table input{
      margin-right: 10px;
    }
  </style>

  <a4j:region>
  <a4j:form>
  <a4j:outputPanel id="userRelationPanel">

    <!-- current user is you -->
    <a4j:commandButton rendered="#{userRelationshipAction.currentUser}" disabled="true"
      styleClass="button" value="#{messages['action.social.user.relationship.isYou']}" />

    <a4j:outputPanel rendered="#{!userRelationshipAction.currentUser}" id="user_relationship_#{widget.id}">
      <c:if test="#{false}">
        <!--

TODO: This part using jQuery Fancybox is temporarly disabled, we use a custom small popup for the moment.

        -->
        <script type="text/javascript">
          jQuery("#add_relationship_#{widget.id}").fancybox({
            'type'    : 'inline'
          });
        </script>

        <!-- Fancy box version ... -->
        <a id="add_relationship_#{widget.id}"
          href="#add_relationship_#{widget.id}">
          <h:outputText value="#{userRelationshipAction.alreadyConnected ? messages['action.social.user.relationship.join'] : messages['action.social.user.relationship.addNew']}" />
        </a>

        <!-- in a fancybox -->
        <div style="display: none;">
          <div id="add_relationship_#{widget.id}">
            <a4j:status>
              <f:facet name="start">
                <h:graphicImage value="/img/standart_waiter.gif" />
              </f:facet>
            </a4j:status>
            <a4j:outputPanel id="add_relationship_#{widget.id}">
              <nxu:dataTable id="#{widget.id}_add_relationship"
                value="#{userRelationshipService.kinds}" var="kind"
                rendered="#{!(userRelationshipAction.currentUser)}">

                <nxu:column>
                  <h:selectBooleanCheckbox valueChangeListener="#{userRelationshipAction.relationshipCheckboxChanged}"
                    value="#{userRelationshipAction.isActiveRelationship(kind)}">
                    <a4j:support event="onchange"
                      reRender="add_relationship_#{widget.id},facesStatusMessagePanel">
                      <f:param name="selectedKind" value="#{kind}" />
                    </a4j:support>
                    <h:outputText value="#{kind}" />
                  </h:selectBooleanCheckbox>
                </nxu:column>
              </nxu:dataTable>
            </a4j:outputPanel>
          </div>
        </div>
      </c:if>

      <a4j:jsFunction name="refresh_add_relationship_#{widget.id}" reRender="user_relationship_#{widget.id}" />
      <script type="text/javascript">
        var btn = jQuery("#add_relationship_#{widget.id}_btn");
        var div = jQuery("#add_relationship_#{widget.id}");

        btn.click(function() {
          return false;
        });
        btn.mouseenter(function() {
          div.fadeIn(500);
        });
        div.mouseleave(function() {
          jQuery("#add_relationship_#{widget.id}").fadeOut(500, refresh_add_relationship_#{widget.id});
        });
      </script>
      <a4j:log />

      <a id="add_relationship_#{widget.id}_btn">
        <h:outputText value="#{userRelationshipAction.alreadyConnected ? messages['action.social.user.relationship.join'] : messages['action.social.user.relationship.addNew']}" />
      </a>

      <div id="add_relationship_#{widget.id}" style="display: none;">
        <a4j:status>
          <f:facet name="start">
            <h:graphicImage value="/img/standart_waiter.gif" />
          </f:facet>
        </a4j:status>
        <a4j:outputPanel id="add_relationship_#{widget.id}">
          <nxu:dataTable id="#{widget.id}_add_relationship"
            value="#{userRelationshipService.kinds}" var="kind"
            rendered="#{!(userRelationshipAction.currentUser)}">

            <nxu:column>
              <h:selectBooleanCheckbox valueChangeListener="#{userRelationshipAction.relationshipCheckboxChanged}"
                value="#{userRelationshipAction.isActiveRelationship(kind)}">
                <a4j:support event="onchange"
                  reRender="add_relationship_#{widget.id},facesStatusMessagePanel">
                  <f:param name="selectedKind" value="#{kind}" />
                </a4j:support>
                <h:outputText value="#{kind}" />
              </h:selectBooleanCheckbox>
            </nxu:column>
          </nxu:dataTable>
        </a4j:outputPanel>
      </div>
    </a4j:outputPanel>

  </a4j:outputPanel>
  </a4j:form>
  </a4j:region>
</f:subview>
